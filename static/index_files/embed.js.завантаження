(()=>{"use strict";(()=>{function e(e){var t;return"object"==typeof e&&null!=e&&"Object"===(null==e||null==(t=e.constructor)?void 0:t.name)}function t(e,r){return Array.isArray(r)?t(e,((e,t)=>r.includes(t))):Object.entries(e).reduce(((e,t)=>{let[a,s]=t;return r(s,a)&&(e[a]=s),e}),{})}function r(e,t){return new r.InputMask(e,t)}function a(e){if(!e)return!1;let t;this.FORM_CALCULATED_CLASS="calculated",this.INPUT_ERROR_CLASS="error",this.ERROR_MESSAGE_CLASS="calc-error-message",this.CURRENCY_CLASS="autonumeric-money",this.PERCENT_CLASS="autonumeric-percent",this.NUMBER_CLASS="autonumeric-number",this.DATE_CLASS="has-datepicker",this.loadedScripts=window.loadedScripts||[],this.callbacks={},this.airDatepickerObjects=[],this.iMaskbjects=[],this.form=e,this.name=this.form.dataset.name,this.lang=this.form.dataset.lang,this.dict={ru:{today:"Сегодня",yesterday:"Вчера",history_empty:"История пуста",error_text:"Не удалось выполнить расчет. Информация об ошибке отправлена администратору.",error_413:"Запрос содержит слишком большой объем данных",copied:"Скопировано",untitled:"Без имени"},en:{today:"Today",yesterday:"Yesterday",history_empty:"History is empty",error_text:"An error occurred. Information has been sent to technical support.",error_413:"Request is too large",copied:"Copied",untitled:"Untitled"}}[this.lang],this.historyAvailable=Boolean(Number(this.form.dataset.history)),this.thousandSeparator="",this.decimalSeparator=".",this.clientWidth=document.documentElement.clientWidth,"ru"===this.lang&&(t="ru-RU"),"en"===this.lang&&(t=navigator.language),this.locale=t,this.numberFormatter=new Intl.NumberFormat(this.locale,{style:"decimal"}),this.currencyFormatter=new Intl.NumberFormat(this.locale,{style:"currency",currency:this.form.currency?.value??"RUB",minimumFractionDigits:0}),this.percentFormatter=new Intl.NumberFormat(this.locale,{style:"percent",maximumFractionDigits:2}),window.addEventListener("DOMContentLoaded",(e=>{})),this.submitButton=this.form.querySelector("input[type=submit]"),this.footer=this.form.querySelector(".calc-footer"),this.resultRows=this.form.querySelectorAll(".result-row"),this.loadingCircle=this.form.querySelector(".loading-row"),this.loadingProgressBar=this.form.querySelector(".calc-loading"),this.getCurrencyFormat(),this.setAutofocus(),this.initAjaxSearchElements(),this.restoreHistoryFromLocalStorage(),this.initKeyboardSubmission(),this.initSpinners(),this.initCurrencyInputs(),this.initDateInputs(),this.initTogglers(),this.initTooltips(),this.initCopy(),this.initCurrencySelector(),this.disableHiddenFields(),this.initAddableRows(),this.initCollapse(),this.initScroll(),this.showFormErrors(JSON.parse(this.form.dataset.errors)),this.form.addEventListener("submit",this.calculate.bind(this)),this.isCalculated()&&(this.formatResultValues(),this.showInsideAd(),document.forms.saveResult&&setTimeout((()=>{document.forms.saveResult.input_data.value=new URLSearchParams(this.getFormData())}),500)),this.form.getAttribute("data-result-id")&&this.form.setAttribute("data-result-hash",btoa(new URLSearchParams(this.getFormData()).toString())),localStorage.getItem("global_currency")&&this.form.currency&&!this.isEmbed()&&!this.isCalculated()&&this.setCurrency(localStorage.getItem("global_currency"))}r.createMask=function(a){if(r.Masked&&a instanceof r.Masked)return a;const s=function(a){if(!a)throw new Error("Options in not defined");if(r.Masked){if(a.prototype instanceof r.Masked)return{mask:a};const{mask:s,...i}=a instanceof r.Masked?{mask:a}:e(a)&&a.mask instanceof r.Masked?a:{};if(s){const e=s.mask;return{...t(s,((e,t)=>!t.startsWith("_"))),mask:s.constructor,_mask:e,...i}}}return e(a)?{...a}:{mask:a}}(a),i=function(e){if(null==e)throw new Error("mask property should be defined");return e instanceof RegExp?r.MaskedRegExp:"string"==typeof(t=e)||t instanceof String?r.MaskedPattern:e===Date?r.MaskedDate:e===Number?r.MaskedNumber:Array.isArray(e)||e===Array?r.MaskedDynamic:r.Masked&&e.prototype instanceof r.Masked?e:r.Masked&&e instanceof r.Masked?e.constructor:e instanceof Function?r.MaskedFunction:(console.warn("Mask not found for mask",e),r.Masked);var t}(s.mask);if(!i)throw new Error("Masked class is not found for provided mask "+s.mask+", appropriate module needs to be imported manually before creating mask.");return s.mask===i&&delete s.mask,s._mask&&(s.mask=s._mask,delete s._mask),new i(s)},a.prototype={getCurrencyFormat(){this.numberFormatter.formatToParts(10000.5).forEach((e=>{"decimal"==e.type&&(this.decimalSeparator=e.value),"group"==e.type&&(this.thousandSeparator=e.value)}))},setAutofocus(){if(!this.isEmbed()&&!this.isCalculated()&&0===JSON.parse(this.form.dataset.errors).length&&this.clientWidth>1024){const e=this.form.querySelector(".autofocus");e&&e.focus()}},registerCallback(e,t){if(!e)throw new Error("Empty callback name");"function"==typeof t&&(this.callbacks[e]=t)},translate(e){return e in this.dict?this.dict[e]:e},isEmbed(){return Boolean(this.form.dataset.embed)},isCalculated(){return this.form.classList.contains(this.FORM_CALCULATED_CLASS)},setCurrency(e){this.form.currency.value=e,document.querySelectorAll(".global-currency-placeholder").forEach((t=>{try{t.textContent=document.querySelector(".set-global-currency[data-id="+e+"]").dataset.sign}catch(t){throw"currency error: "+e}})),this.currencyFormatter=new Intl.NumberFormat(this.locale,{style:"currency",currency:e,minimumFractionDigits:0})},disableHiddenFields(){this.form.querySelectorAll(".calc-frow").forEach((e=>{if(e.classList.contains("result-row")||e.classList.contains("result-sep")||e.classList.contains("loading-row"))return!1;"none"==e.style.display?e.querySelectorAll("input, select, textarea").forEach((e=>e.disabled=!0)):e.querySelectorAll(".calc-input").forEach((e=>{"none"==e.style.display&&e.querySelectorAll("input, select, textarea").forEach((e=>e.disabled=!0))}))}))},startFormLoading(){let e=document.createElement("div");e.classList.add("calc-loader"),this.form.appendChild(e)},stopFormLoading(){this.form.querySelector(".calc-loader").remove()},hideResults(){this.resultRows.forEach((e=>e.style.display="none")),document.querySelectorAll(".calc-panel-item.result-only").forEach((e=>{e.style.display="none"})),this.form.classList.remove("calculated")},showLoading(){this.submitButton.disabled=!0,this.loadingCircle&&(this.loadingCircle.style.display="block"),document.activeElement===this.submitButton&&this.submitButton.blur()},hideLoading(){this.loadingCircle&&(this.loadingCircle.style.display="none"),this.loadingProgressBar&&(this.loadingProgressBar.style.width="0",this.loadingProgressBar.style.display="none"),this.submitButton.disabled=!1},initAjaxSearchElements(){this.form.querySelectorAll(".ajax-search").forEach((e=>{let t;const r=e.dataset.hiddenfield,a=e.dataset.url,s=e.dataset.value,i=e.dataset.name,o=e.dataset.min||2,n=e.dataset.callback;if(!r)throw new Error("Hidden element name is not provided");if(!a)throw new Error("Search URL is not provided");const l=document.createElement("div");l.classList.add("ajax-search-wrapper"),e.parentNode.insertBefore(l,e),l.appendChild(e);let c=document.createElement("input");c.setAttribute("type","hidden"),c.setAttribute("name",r);let d=document.createElement("div");d.classList.add("search-results");let u=document.createElement("div");u.classList.add("spinner-border"),u.style.display="none";let h=document.createElement("div");function m(e,t){(t=t||!1)||(d.textContent="");let r=document.createElement("div");r.classList.add(t?"search-result-item":"search-result-text"),r.textContent=e,t&&(r.dataset.id=t,r.addEventListener("click",(r=>{f(),p(t,e),n in this.callbacks?this.callbacks[n](t,e):console.log(`Warning: Callback function ${n} is not registered`)}))),d.append(r)}function p(r,a){clearTimeout(t),c.value=r,e.value=a,e.setAttribute("readonly",!0),h.style.display="block"}function f(){d.textContent="",d.style.display="none",e.value="",e.removeAttribute("readonly"),h.style.display="none",c.value=""}h.classList.add("search-cancel"),h.style.display="none",l.append(c,d,u,h),s&&i&&p(s,i),e.addEventListener("input",(r=>{const a=r.target.value;a.length>=o?(u.style.display="",clearTimeout(t),t=setTimeout((()=>{let t=new XMLHttpRequest;t.open("GET",e.dataset.url+"?q="+encodeURIComponent(a),!0),t.onload=()=>{if(t.status>=200&&t.status<400){const e=JSON.parse(t.response);for(;d.firstChild;)d.removeChild(d.lastChild);if(e.length>0)for(let t in e)m.call(this,e[t].name,e[t].id);else m("Ничего не найдено");d.style.display="block",u.style.display="none"}},t.send()}),500)):a.length>=1?(m("Введите минимум "+o+" символа"),d.style.display="block"):f()})),e.addEventListener("keydown",(function(e){"Escape"===e.key&&f(),"Enter"===e.key&&e.preventDefault()})),h.addEventListener("click",(t=>{f(),e.focus()})),document.addEventListener("click",(e=>{e.target.closest(".ajax-search-wrapper")||""===c.value&&(f(),e.stopPropagation())}))}))},restoreHistoryFromLocalStorage(){if(!("localStorage"in window))return!1;if(!this.historyAvailable)return!1;const e=document.getElementById("historyOffcanvas")?.querySelector(".offcanvas-body");if(!e)return!1;const t="history_"+this.name;e.textContent="";let r=localStorage.getItem(t);if(r)try{r=JSON.parse(r).reverse()}catch(e){r=[]}else r=[];r.sort(((e,t)=>new Date(e.date)>new Date(t.date)?-1:1)),document.querySelector(".history-count-placeholder").textContent=r.length;for(let t in r){let a=document.createElement("div");a.classList.add("sidebar-item","flex-column");let s,i,o=document.createElement("a"),n=document.createElement("div");n.classList.add("text-muted","mt-1","small"),s=r[t].name?r[t].name:this.translate("untitled");let l=new Date(r[t].date),c=new Date,d=new Date;d.setDate(d.getDate()-1),i=l.toDateString()===c.toDateString()?this.translate("today")+", "+l.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):l.toDateString()===d.toDateString()?this.translate("yesterday")+", "+l.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):l.toLocaleString([],{month:"long",day:"numeric"}),o.innerHTML=s,o.setAttribute("href","?input="+("object"==typeof r[t].data?JSON.stringify(r[t].data):r[t].data)),n.textContent=i,a.append(o),a.append(n),e.append(a)}if(0===e.childElementCount){let t=document.createElement("div");t.classList.add("sidebar-item","text-muted","text-nowrap"),t.textContent=this.translate("history_empty"),e.append(t)}},addHistoryToLocalStorage(e,t){if(!("localStorage"in window))return!1;const r=document.getElementById("historyOffcanvas")?.querySelector(".offcanvas-body");if(!r)return!1;const a="history_"+this.name;let s=localStorage.getItem(a);if(s)try{s=JSON.parse(s).reverse()}catch(e){s=[]}else s=[];for(let e in s)s[e].data===t&&s.splice(e,1);s.push({date:new Date,calc:this.name,name:e,data:t}),s.sort(((e,t)=>new Date(e.date)>new Date(t.date)?-1:1)),s.splice(20),localStorage.setItem(a,JSON.stringify(s))},initKeyboardSubmission(){document.querySelectorAll("textarea[data-keyboard]").forEach((e=>{e.addEventListener("keydown",(e=>{e.ctrlKey&&"Enter"===e.key&&e.target.form.dispatchEvent(new Event("submit",{bubbles:!0,cancelable:!0}))}))}))},initSpinners(){const e=document.querySelectorAll(".js-spinner");if(!e)return!1;e.forEach((e=>{e.addEventListener("click",(t=>{const r=e.dataset.input,a=e.dataset.direction,s=document.querySelector("input[name="+r+"]"),i=s.getAttribute("min"),o=s.getAttribute("max");let n=Number(s.value);"down"===a&&n>i&&(n-=1),"up"===a&&n<o&&(n+=1),s.value=n,t.stopPropagation(),t.preventDefault()}))}))},initCurrencyInputs(){Array.prototype.forEach.call(this.form.getElementsByClassName(this.CURRENCY_CLASS),(e=>this.formatInputAsCurrency(e))),Array.prototype.forEach.call(this.form.getElementsByClassName(this.PERCENT_CLASS),(e=>this.formatInputAsPercent(e))),Array.prototype.forEach.call(this.form.getElementsByClassName(this.NUMBER_CLASS),(e=>this.formatInputAsNumber(e)))},initDatePicker(e){if(this.isEmbed())return e.type="date",!1;let t;e.pattern="\\d{2}.\\d{2}.\\d{4}",e.value?e.classList.contains("error")?(e.value="",t=null):(t=e.value,e.value=e.value.split("-").reverse().join(".")):t=null;const r=new AirDatepicker(e,{keyboardNav:!1,autoClose:!0,toggleSelected:!1,dateFormat:"dd.MM.yyyy",showEvent:!1,isMobile:this.clientWidth<768,fixedHeight:!0,selectedDates:[t].filter((e=>e)),onSelect:({date:t,formattedDate:r,datepicker:a})=>{if(s.updateValue(r),a.$el.readOnly=!1,e.dataset.onselect){let s=e.dataset.onselect;s in this.callbacks?this.callbacks[s](e,t,r,a):console.warn(`Callback function ${s} is not registered`)}},onHide:()=>{e.readOnly=!1}});r.$el.readOnly=!1;const a={mask:Date,lazy:!0},s=IMask(e,a);s.on("complete",(e=>{r.selectDate(s.typedValue),r.setViewDate(s.typedValue)})),e.addEventListener("focus",(function(e){let t=!s.value;setTimeout((()=>{s.updateOptions(Object.assign(a,{lazy:!1})),t&&this.setSelectionRange(0,0)}),0)})),e.addEventListener("blur",(e=>{s.updateOptions(Object.assign(a,{lazy:!0}))}));const i=e.nextElementSibling;i?.addEventListener("click",(t=>{r.visible?r.hide():(r.show(),this.clientWidth>=768&&e.focus())})),this.airDatepickerObjects.push(r),this.iMaskbjects.push(s),e.setAttribute("data-datepicker-id",this.airDatepickerObjects.indexOf(r))},removeDatePicker(e){delete this.airDatepickerObjects[e],delete this.iMaskbjects[e]},initDateInputs(){"ru"===this.lang&&this.form.querySelectorAll("input.has-datepicker").forEach((e=>{this.initDatePicker(e)}))},initTogglers(){this.form.querySelectorAll(".js-calc-toggle").forEach((e=>{e.addEventListener("A"===e.tagName||"SPAN"===e.tagName?"click":"change",(e=>{const t=e.currentTarget,r=t.tagName;let a,s,i;"SELECT"===r&&(a=t.name,s=t.value,i=t.options[t.selectedIndex].dataset.autofocus),"INPUT"===r&&(a=t.name,"radio"===t.getAttribute("type")&&(s=t.value),"checkbox"===t.getAttribute("type")&&(s=t.checked.toString().toLowerCase()),i=t.dataset.autofocus),("A"===r||"SPAN"===r)&&(a=t.dataset.name,s=t.dataset.value,i=t.dataset.autofocus,this.form[a].value=s,t.parentElement.querySelectorAll(".js-calc-toggle").forEach((e=>{e.classList.remove("current")})),t.classList.add("current"),t.classList.contains("calc-toggle-button")&&this.hideResults()),this.toggleFields(a,s,i),e.preventDefault()}))}))},initTooltips(){CalcusBootstrap.Tooltip.Default.html=!0,CalcusBootstrap.Tooltip.Default.animation=!1;const e=this.form.querySelectorAll('[data-bs-toggle="calc-tooltip"]');Array.from(e).forEach((e=>{e.getAttribute("data-bs-original-title")||new CalcusBootstrap.Tooltip(e,{container:".calc-form"})}))},initCopy(){this.form.querySelectorAll("[data-action=copy]").forEach((e=>{e.dataset.copyInit||(e.setAttribute("data-copy-init","1"),e.addEventListener("click",(t=>{let r=this.form.querySelector(e.dataset.copyselector).textContent.trim();r=r.replaceAll(/\n\s+/g,"\n"),e.dataset.unformat&&(r=this.parseLocaleNumber(r));const a=document.createElement("textarea");a.value=r,a.setAttribute("readonly",""),a.style.position="absolute",a.style.left="-9999px",document.body.appendChild(a),a.select(),document.execCommand("copy"),document.body.removeChild(a);let s=e.getAttribute("data-bs-original-title");s&&s!==this.translate("copied")&&CalcusBootstrap.Tooltip.getInstance(e)&&CalcusBootstrap.Tooltip.getInstance(e).dispose(),e.setAttribute("title",this.translate("copied")),new CalcusBootstrap.Tooltip(e,{container:".calc-form"}).show(),e.addEventListener("mouseleave",(t=>{CalcusBootstrap.Tooltip.getInstance(e)&&(CalcusBootstrap.Tooltip.getInstance(e).dispose(),s&&s!==this.translate("copied")&&(e.setAttribute("title",s),new CalcusBootstrap.Tooltip(e,{container:".calc-form"})))}))})))}))},expandTable(e){e.closest("table").querySelectorAll("tr").forEach((e=>{e.style.display=""})),e.closest("tr").remove(),this.sendHeight()},formatInputAsCurrency(e){const t={numeral:!0,delimiter:this.thousandSeparator,numeralDecimalMark:this.decimalSeparator};return new Cleave(e,t)},formatInputAsPercent(e){const t={numeral:!0,delimiter:"",numeralDecimalMark:this.decimalSeparator,numeralIntegerScale:3,numeralDecimalScale:3};return new Cleave(e,t)},formatInputAsNumber(e){const t={numeral:!0,delimiter:"",numeralDecimalMark:this.decimalSeparator,numeralDecimalScale:10};return new Cleave(e,t)},parseLocaleNumber(e){let t=parseFloat(e.replace(new RegExp("\\"+this.thousandSeparator,"g"),"").replace(this.decimalSeparator,"."));return isNaN(t)?"":t},highlightError(e,t){e instanceof RadioNodeList&&(e=e[0]),t=(t=(t=(t=t.replace("Пожалуйста,","").trim()).replace("Please","").trim()).replace(/\.$/,"")).charAt(0).toUpperCase()+t.slice(1),"SELECT"===e.tagName&&e.validity.valueMissing&&(/^en/.test(navigator.language)&&(t="Select an item"),/^ru/.test(navigator.language)&&(t="Выберите вариант"));let r=document.getElementById(e.name+"-error");r?r.textContent=t:(r=document.createElement("div"),r.id=e.name+"-error",r.classList.add(this.ERROR_MESSAGE_CLASS),r.innerHTML=t,e.classList.contains("choices__input")?(e.closest(".choices").classList.add(this.INPUT_ERROR_CLASS),e.closest(".choices").insertAdjacentElement("afterend",r)):"radio"==e.getAttribute("type")?e.closest(".calc-input")&&(r.style.marginTop="5px",e.closest(".calc-input").insertAdjacentElement("beforeend",r)):(e.classList.add(this.INPUT_ERROR_CLASS),e.insertAdjacentElement("afterend",r))),this.sendHeight()},unhighlightError(e){e.classList.remove(this.INPUT_ERROR_CLASS),e.nextElementSibling&&e.nextElementSibling.classList.contains(this.ERROR_MESSAGE_CLASS)&&e.nextElementSibling.remove()},hideFormErrors(){for(let e of this.form.elements)e.classList.contains(this.INPUT_ERROR_CLASS)&&e.classList.remove(this.INPUT_ERROR_CLASS);this.form.querySelectorAll("."+this.ERROR_MESSAGE_CLASS).forEach((e=>e.remove())),this.form.querySelector(".error-row")&&this.form.querySelector(".error-row").remove(),this.form.querySelectorAll(".calc-row-error").forEach((e=>e.remove())),this.sendHeight()},showFormErrors(e){for(const[t,r]of Object.entries(e))if("common_error"===t){let e='<div class="calc-frow error-row"><div>'+r+"</div></div>";this.footer.insertAdjacentHTML("beforebegin",e)}else if(Array.isArray(r))r.sort(((e,t)=>t.index-e.index)),r.forEach((e=>{this.form.querySelector("table."+t).rows[e.index].insertAdjacentHTML("afterend",'<tr class="calc-row-error"><td colspan="100%">'+e.message+"</td></tr>")}));else{const e=this.form[t];this.highlightError(e,r),this.listenElementForErrors(e)}},stopCalculation(){this.hideResults(),this.hideLoading(),this.sendHeight()},stopCalculationAndShowError(e){this.stopCalculation(),e=e||this.translate("error_text"),alert(e)},focusFirstElementWithError(){for(let e of this.form)if(e.classList.contains(this.INPUT_ERROR_CLASS)){e.focus();break}},validate(){for(let e of this.form.elements)e.willValidate&&(this.checkFieldValidity(e),this.listenElementForErrors(e));return this.focusFirstElementWithError(),this.form.checkValidity()},checkFieldValidity(e){e.checkValidity()?this.unhighlightError(e):this.highlightError(e,e.validationMessage)},listenElementForErrors(e){("INPUT"!==e.tagName||"text"!==e.type&&"number"!==e.type&&"date"!==e.type)&&"TEXTAREA"!==e.tagName||e.addEventListener("input",this.checkFieldValidity.bind(this,e)),"SELECT"===e.tagName&&e.addEventListener("change",this.checkFieldValidity.bind(this,e))},getFormData(){let e=new FormData,t=new FormData(this.form);const r=[...new Set([].map.call(this.form.getElementsByClassName(this.CURRENCY_CLASS),(e=>e.name)))],a=[...new Set([].map.call(this.form.getElementsByClassName(this.PERCENT_CLASS),(e=>e.name)))],s=[...new Set([].map.call(this.form.getElementsByClassName(this.NUMBER_CLASS),(e=>e.name)))],i=[...new Set([].map.call(this.form.getElementsByClassName(this.DATE_CLASS),(e=>e.name)))];for(const[o,n]of t.entries())r.includes(o)&&n?e.append(o,this.parseLocaleNumber(n)):a.includes(o)||s.includes(o)?e.append(o,n.replace(this.decimalSeparator,".")):i.includes(o)?e.append(o,n.split(".").reverse().join("-")):e.append(o,n);return this.isEmbed()&&(e.append("isEmbed",1),e.append("lang",this.lang)),e},getFormDataHash(){return btoa(new URLSearchParams(this.getFormData()).toString())},getFormDataAsJson(e){let t={};return e.forEach(((e,r)=>{let a;(a=r.match(/\[(.+)\]/))?(r=r.replace(/\[(.+)\]/,""),t.hasOwnProperty(r)||(t[r]={}),t[r][a[1]]=e):r.indexOf("[]")>=0?(r=r.replace("[]",""),t.hasOwnProperty(r)||(t[r]=[]),t[r].push(e)):t[r]=e})),t},calculate(e){if(e.preventDefault(),!this.validate())return!1;var t=new Date;if(this.loadingProgressBar){var r=750;this.loadingProgressBar.style.width="0",this.loadingProgressBar.style.display="block";var a=0,s=new Date,i=setInterval((()=>{a=Math.ceil((new Date-s)/(r/100)),this.loadingProgressBar.style.width=a.toString()+"%",100===a&&clearInterval(i)}),r/100)}else r=500;this.hideFormErrors(),this.hideResults(),this.showLoading(),this.sendHeight(),this.form.classList.remove(this.FORM_CALCULATED_CLASS);const o=this.getFormData();let n=new XMLHttpRequest;n.open(this.form.getAttribute("method"),this.form.getAttribute("action"),!0),n.onerror=()=>{this.stopCalculationAndShowError()},n.onload=()=>{if(200===n.status){try{var e=JSON.parse(n.response)}catch(e){return void this.stopCalculationAndShowError()}"errors"in e?r=0:this.isEmbed()||(this.footer.nextElementSibling?this.footer.getBoundingClientRect().top-document.documentElement.clientHeight+this.footer.offsetHeight>0&&window.scrollTo(0,window.scrollY+this.footer.getBoundingClientRect().top):this.footer.getBoundingClientRect().top-document.documentElement.clientHeight+this.footer.offsetHeight>0&&window.scrollTo(0,this.footer.getBoundingClientRect().top+window.scrollY-document.documentElement.clientHeight+this.footer.offsetHeight));var a=new Date-t,s=r-a;s<0&&(s=0),setTimeout((()=>{clearInterval(i),this.hideLoading();let t=!1;if("errors"in e&&(t=!0,this.showFormErrors(e.errors),this.focusFirstElementWithError()),!t){for(var r in e)this.form.querySelectorAll(".result-placeholder-"+r).forEach((function(t){"INPUT"===t.tagName||"TEXTAREA"===t.tagName?t.value=e[r]:t.innerHTML=e[r];const a=t.closest(".result-row");a&&(a.style.display="block")}));if(this.form.classList.add(this.FORM_CALCULATED_CLASS),o.delete("isEmbed"),this.formatResultValues(),this.initTooltips(),this.initCopy(),this.initScroll(),this.afterCalculateCallback(e),!this.isEmbed()){this.showInsideAd(),this.addCalcToLastUsed(),e.hasOwnProperty("ad")||e.hasOwnProperty("offers")||this.showCommonInsideAd(),"suggested_name"in e&&(this.form.dataset.suggested=e.suggested_name),document.forms.saveResult&&(document.forms.saveResult.input_data.value=new URLSearchParams(o));const t=e.encoded_input_data;this.historyAvailable&&(this.form.getAttribute("data-result-id")?this.getFormDataHash()===this.form.getAttribute("data-result-hash")?(history.pushState(t,"","?result="+this.form.getAttribute("data-result-id")),document.querySelector(".saved-result-changed-warning").style.display="none"):(history.pushState(t,"","?input="+t),document.querySelector(".saved-result-changed-warning").style.display=""):history.pushState(t,"","?input="+t),this.addHistoryToLocalStorage("suggested_name"in e?e.suggested_name:null,t),this.restoreHistoryFromLocalStorage()),document.querySelectorAll(".calc-panel-item.result-only").forEach((e=>{e.style.display=""}));const r=document.querySelector(".today-count-placeholder");if("increase_counter"in e&&r){let e=Number(r.textContent);e++,r.textContent=e.toString()}this.name&&("function"==typeof ym?(ym(30023134,"reachGoal","calculated_"+this.name),"offer_number"in e&&ym(30023134,"reachGoal","show_offer_"+this.name+"_"+e.offer_number)):(console.log("reach goal: calculated_"+this.name),"offer_number"in e&&console.log("reach goal: show_offer_"+this.name+"_"+e.offer_number)))}}this.sendHeight()}),s)}else{if(429===n.status)return this.stopCalculation(),void(this.isEmbed()?alert("To many requests"):this.showCaptcha());let e;e=413===n.status&&this.translate("error_413"),this.stopCalculationAndShowError(e)}},n.send(o)},afterCalculateCallback(e){},showInsideAd(){if(this.isEmbed())return!1;if("Deposit"===this.name&&document.getElementById("a_in_result_dom_rf")){const e=document.getElementById("a_in_result_dom_rf");let t=`<div class="text-center"><a href="${e.dataset.click}${Math.random()}" target="_blank"><img src="/images/banners/domrf/Calcus_300x250.png?${e.dataset.cache}"></a></div>`;t+=`<img src="${e.dataset.pixel}${Math.random()}">`;let r=`<div class="text-center"><a href="${e.dataset.click}${Math.random()}" target="_blank"><img src="/images/banners/domrf/Calcus_728x90.png?${e.dataset.cache}" style="max-width: 100%"></a></div>`;return r+=`<img src="${e.dataset.pixel}${Math.random()}">`,void(document.documentElement.clientWidth>=768?e.innerHTML=r:e.innerHTML=t)}const e=document.getElementById("a_in_result");if(!e)return!1;const t={Credit:1,Mortgage:2,Creditd:3,Deposit:4,Invest:5};this.loadScript("https://yandex.ru/ads/system/context.js").then((()=>{window.yaContextCb.push((()=>{Ya.Context.AdvManager.render({renderTo:e.id,blockId:this.clientWidth>=768?"R-A-752040-4":"R-A-752040-5",statId:t[this.name]})}))})).catch((()=>{}))},showCommonInsideAd(){this.clientWidth<1200&&(document.getElementById("inside_narrow_banner_placeholder").parentElement.style.display="",window.yaContextCb.push((()=>{Ya.Context.AdvManager.render({renderTo:"inside_narrow_banner_placeholder",blockId:"R-A-752040-13"})})))},formatResultValues(){this.form.querySelectorAll(".format-currency").forEach((e=>{let t=e.textContent.trim();t=t.replace(/([^\u{00A0}.,0-9]+)/u,' <span class="fw-normal calc-text-desc" style="font-size: 1rem">$1</span> '),e.innerHTML=t.trim()})),this.form.querySelectorAll(".result-format-currency").forEach((e=>{if(""===e.textContent.trim())return;let t=e.textContent.trim();t=this.currencyFormatter.format(t),t=t.replace(/([^\u{00A0}.,0-9]+)/u,' <span class="fw-normal calc-text-desc">$1</span> '),e.innerHTML=t})),this.form.querySelectorAll(".result-format-number").forEach((e=>{if(""===e.textContent.trim())return;e.dataset.raw=e.textContent.trim();let t=e.textContent.trim();e.innerHTML=this.numberFormatter.format(t)})),this.form.querySelectorAll(".result-format-percent").forEach((e=>{let t=e.textContent.trim();t=this.percentFormatter.format(t),t=t.replace(/([^\u{00A0}.,0-9]+)/u,' <span class="fw-normal calc-text-desc">$1</span> '),e.innerHTML=t}))},sendHeight(){},toggleFields(e,t,r){if(this.form.querySelectorAll("."+e+"-x").forEach((t=>{let r=!0;if(t.classList.contains("depends-or")){let a=Array.from(t.classList).filter((e=>e.endsWith("-x"))).map((e=>e.slice(0,-2)));a.splice(a.indexOf(e),1);for(let e of a){if(!this.form[e])continue;let a=this.form[e].value;t.classList.contains(e+"-"+a)&&(r=!1)}}r&&(t.style.display="none",t.querySelectorAll("input, select, textarea").forEach((e=>e.disabled=!0)))})),this.form.querySelectorAll("."+e+"-"+t).forEach((t=>{let r=!0;if(!t.classList.contains("depends-or")){let a=Array.from(t.classList).filter((e=>e.endsWith("-x"))).map((e=>e.slice(0,-2)));a.splice(a.indexOf(e),1);for(let e of a){if(!this.form[e])continue;let a=this.form[e].value;t.classList.contains(e+"-"+a)||(r=!1)}}r&&(t.style.display="",t.querySelectorAll("input, select, textarea").forEach((e=>e.disabled=!1)))})),r&&this.clientWidth>1024){let e=this.form[r];if(e){if("length"in e)for(let t of e)if(!t.disabled){e=t;break}e.focus()}}this.sendHeight()},initCurrencySelector(){const e=document.getElementById("currencyModal"),t=document.querySelectorAll(".set-global-currency"),r=document.querySelector(".search-global-currency");if(!e)return!1;e.addEventListener("shown.bs.modal",(e=>{this.clientWidth>=1200&&e.target.querySelector(".search-global-currency").focus(),t.forEach((e=>{e.classList.remove("current")}));try{e.target.querySelector(".set-global-currency[data-id="+this.form.currency.value+"]").classList.add("current")}catch(e){throw"currency error in modal: "+this.form.currency.value}})),t.forEach((r=>{r.addEventListener("click",(a=>{a.preventDefault(),t.forEach((e=>{e.classList.remove("current")})),r.classList.add("current"),localStorage.setItem("global_currency",r.dataset.id),CalcusBootstrap.Modal.getInstance(e).hide(),this.setCurrency(r.dataset.id)}))})),r.addEventListener("input",(e=>{document.querySelectorAll(".set-global-currency").forEach((t=>{t.textContent.toLowerCase().includes(e.target.value.toLowerCase())||t.dataset.description.toLowerCase().includes(e.target.value.toLowerCase())?t.parentElement.style.display="":t.parentElement.style.display="none"}))}))},loadScript(e){return location.host.includes("0.0.0.0")||e.includes("http")||(e="https://calcus.ru"+e),new Promise(((t,r)=>{if(this.loadedScripts.indexOf(e)>=0)t(!0);else{let a=document.createElement("script");a.type="text/javascript",a.src=e,a.onload=()=>{this.loadedScripts.push(e),t(!1)},a.onerror=r,document.body.appendChild(a)}}))},print(){"function"==typeof ym&&ym(30023134,"reachGoal","print");const e=document.getElementsByTagName("article")[0];e.classList.add("d-print-none"),window.print(),setTimeout((()=>{e.classList.remove("d-print-none")}),2e3)},initAddableRows(){const e=e=>{const t=e.currentTarget.dataset.callback,r=e.target.closest("table");let a;a="TABLE"===r.tagName?e.target.closest("tr"):e.target.closest(".array-data-row"),a.querySelectorAll("."+this.DATE_CLASS).forEach((e=>{if(e.hasAttribute("data-datepicker-id")){const t=e.getAttribute("data-datepicker-id");Calc.removeDatePicker(t)}})),a.nextElementSibling&&a.nextElementSibling.classList.contains("calc-row-error")&&a.nextElementSibling.remove(),a.remove(),"TABLE"===r.tagName?1===r.tBodies[0].rows.length&&(r.style.display="none"):1===r.children.length&&(r.style.display="none"),t&&(t in this.callbacks?this.callbacks[t](a):console.warn(`Callback function ${t} is not registered`)),this.sendHeight(),e.preventDefault()};this.form.querySelectorAll(".js-add-row").forEach((t=>{t.addEventListener("click",(r=>{const a=r.target.dataset.callback,s=this.form.querySelector("."+t.dataset.target);let i;i="TABLE"===s.tagName?s.tBodies[0].rows[0].cloneNode(!0):s.firstElementChild.cloneNode(!0),i.style.display="",i.querySelector(".js-delete-row").addEventListener("click",e),i.querySelectorAll("input, select").forEach((e=>{e.disabled=!1,e.classList.contains(this.CURRENCY_CLASS)&&this.formatInputAsCurrency(e),e.classList.contains(this.PERCENT_CLASS)&&this.formatInputAsPercent(e)})),"TABLE"===s.tagName?s.tBodies[0].insertAdjacentElement("beforeend",i):s.insertAdjacentElement("beforeend",i),s.style.display="",i.querySelector("input, select").focus(),i.querySelectorAll("."+this.DATE_CLASS).forEach((e=>{Calc.initDatePicker(e)})),a&&(a in this.callbacks?this.callbacks[a](i):console.warn(`Callback function ${a} is not registered`)),this.sendHeight(),r.preventDefault()}))})),this.form.querySelectorAll(".js-delete-row").forEach((t=>t.addEventListener("click",e)))},initCollapse(){this.form.querySelectorAll(".calc-js-collapse").forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault();const r=document.getElementById(e.dataset.collapse);r&&("none"===r.style.display?(r.style.display="",t.target.querySelector("use").setAttribute("xlink:href","#icon-chevron-up"),e.dataset.focus&&this.form[e.dataset.focus].focus()):(r.style.display="none",t.target.querySelector("use").setAttribute("xlink:href","#icon-chevron-down")))}))}))},initScroll(){const e=this.form.querySelector(".calc-scroll-up");if(!e)return!1;e.addEventListener("click",(e=>{e.preventDefault();const t=this.footer.getBoundingClientRect(),r=window.scrollY+t.top,a=window.scrollY,s=r-a;let i;window.requestAnimationFrame((function e(t){i||(i=t);const r=t-i;let o=Math.min(r/500,1);o=1-Math.pow(1-o,2),window.scrollTo(0,a+s*o),r<500&&window.requestAnimationFrame(e)}))}))},addCalcToLastUsed(){let e=localStorage.getItem("last_used")??"[]";e=JSON.parse(e),e.unshift(this.name),e=[...new Set(e)],e.splice(5),localStorage.setItem("last_used",JSON.stringify(e))},showCaptcha(){const e=document.getElementById("captchaModal"),t=e.querySelector(".captcha-container");let r;if(CalcusBootstrap.Modal.getOrCreateInstance(e).show(),t.classList.contains("rendered"))return!1;this.loadScript("https://smartcaptcha.yandexcloud.net/captcha.js").then((()=>{r=window.smartCaptcha.render(t,{sitekey:"ysc1_BMOwABdvEdwH5wxuwNyR0pZqU0JW6za2SICzLXoz6687b1e9",hl:this.lang,callback:"captchaCallback"}),t.classList.add("rendered")})).catch((()=>{})),window.captchaCallback=function(a){let s=new XMLHttpRequest;s.open("POST","/ajax/check_captcha",!0),s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.onload=()=>{if(200===s.status){let a;try{a=JSON.parse(s.response)}catch(e){return alert("Error"),!1}"ok"===a.status?(CalcusBootstrap.Modal.getInstance(e).hide(),t.style.height="auto",t.classList.remove("rendered"),window.grecaptcha&&grecaptcha.reset(void 0),window.smartCaptcha&&window.smartCaptcha.destroy(r)):"error"===a.status&&alert(a.error)}else alert("Error")},s.send("token="+a+"&source=y")}}},window.Calcus=a})()})();